<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel and CSV File Comparison</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Excel and CSV File Comparison</h1>
    <div class="fixed-header">
    <div id="summary"></div>
    <div class="container">
        <div class="table-container">
            <label class="file-label">File 1 (Excel or CSV):</label><br>
            <input type="file" id="file1" accept=".xlsx,.xls,.csv" onchange="handleFile1(event)"><br>
            <div id="table1"></div>
            <div id="preview1"></div>
        </div>
        <div class="table-container">
            <label class="file-label">File 2 (Excel or CSV):</label><br>
            <input type="file" id="file2" accept=".xlsx,.xls,.csv" onchange="handleFile2(event)"><br>
            <div id="table2"></div>
            <div id="preview2"></div>
        </div>
        <div class="controls-container">
            <button class="compare-btn" onclick="compareTables()">Compare</button>
            <label style="margin-left:20px;"><input type="checkbox" id="hideSameRows" onchange="compareTables()"> Hide identical rows below</label>
        </div>
    </div>
    </div>
    <div id="result"></div>
    <div id="diffTable">
        <div class="table-header-fixed">
            <table class="diff-table-header">
                <thead></thead>
                <tbody class="filter-row"></tbody>
            </table>
        </div>
        <div class="table-body-scrollable">
            <table class="diff-table-body">
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
    let data1 = [], data2 = [];
    let fileName1 = '', fileName2 = '';

    document.getElementById('file1').addEventListener('change', function(e) {
        handleFile(e.target.files[0], 1);
    });
    document.getElementById('file2').addEventListener('change', function(e) {
        handleFile(e.target.files[0], 2);
    });

    function handleFile(file, num) {
        if (!file) return;
        if (num === 1) {
            fileName1 = file.name;
        } else {
            fileName2 = file.name;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            let data = new Uint8Array(e.target.result);
            let workbook = XLSX.read(data, {type: 'array'});
            let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let json = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ''});
            // Удаляем полностью пустые строки
            json = json.filter(row => Array.isArray(row) && row.some(cell => (cell !== null && cell !== undefined && cell.toString().trim() !== '')));
            if (num === 1) {
                data1 = json;
                renderPreview(json, 'preview1');
            } else {
                data2 = json;
                renderPreview(json, 'preview2');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function renderTable(data, elementId, diffRowsSet) {
        let html = '<table>';
        if (data.length > 0) {
            html += '<tr>';
            for (let j = 0; j < data[0].length; j++) {
                html += `<th>${data[0][j]}</th>`;
            }
            html += '</tr>';
        }
        for (let i = 1; i < data.length; i++) { // начинаем с 1, чтобы не дублировать заголовки
            let rowClass = (diffRowsSet && diffRowsSet.has(i)) ? 'diff' : '';
            html += `<tr class="${rowClass}">`;
            for (let j = 0; j < data[i].length; j++) {
                html += `<td>${data[i][j]}</td>`;
            }
            html += '</tr>';
        }
        html += '</table>';
        document.getElementById(elementId).innerHTML = html;
    }

    function renderPreview(data, elementId, title) {
        let html = '';
        if (data.length > 0) {
            html += '<table class="preview-table">';
            // Заголовки
            if (data[0] && data[0].length > 0) {
                html += '<tr>';
                for (let j = 0; j < data[0].length; j++) {
                    html += `<th>${data[0][j]}</th>`;
                }
                html += '</tr>';
            }
            // Первые 3 строки данных
            for (let i = 1; i < Math.min(4, data.length); i++) {
                html += '<tr>';
                for (let j = 0; j < data[i].length; j++) {
                    html += `<td>${data[i][j]}</td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
        }
        document.getElementById(elementId).innerHTML = html;
    }

    function rowToKey(row) {
        // Преобразуем строку в строку-ключ для сравнения
        return JSON.stringify(row);
    }

    function compareTables() {
        if (!data1.length || !data2.length) {
            document.getElementById('result').innerText = 'Please, load both files.';
            document.getElementById('summary').innerHTML = '';
            document.getElementById('diffTable').innerHTML = '';
            return;
        }
        // --- Статистика ---
        let header1 = data1[0] || [];
        let header2 = data2[0] || [];
        let allCols = Math.max(header1.length, header2.length);
        let headers = (header1.length >= header2.length) ? header1 : header2;
        let body1 = data1.slice(1);
        let body2 = data2.slice(1);
        // Формируем ключи для точного совпадения
        function rowKey(row) { return JSON.stringify(row.map(x => (x !== undefined ? x : ''))); }
        let set1 = new Set(body1.map(rowKey));
        let set2 = new Set(body2.map(rowKey));
        let only1 = 0, only2 = 0, both = 0;
        set1.forEach(k => { if (set2.has(k)) both++; else only1++; });
        set2.forEach(k => { if (!set1.has(k)) only2++; });
        // --- Верхняя таблица ---
        let totalRows = Math.max(data1.length, data2.length) - 1;
        let maxRows = Math.max(body1.length, body2.length);
        let percentDiff = maxRows > 0 ? (((only1 + only2) / maxRows) * 100).toFixed(2) : '0.00';
        let percentClass = 'percent-low';
        if (parseFloat(percentDiff) > 30) percentClass = 'percent-high';
        else if (parseFloat(percentDiff) > 10) percentClass = 'percent-medium';
        let htmlSummary = `
            <table style="margin-bottom:20px; border: 1px solid #ccc;">
                <tr><th>File</th><th>Row Count</th><th>Rows only in this file</th><th>Identical rows</th><th>% Difference</th></tr>
                <tr><td>${fileName1 || 'File 1'}</td><td>${body1.length}</td><td>${only1}</td><td rowspan="2">${both}</td><td rowspan="2" class="percent-cell ${percentClass}">${percentDiff}%</td></tr>
                <tr><td>${fileName2 || 'File 2'}</td><td>${body2.length}</td><td>${only2}</td></tr>
            </table>
        `;
        document.getElementById('summary').innerHTML = htmlSummary;
        // --- Нестрогое сопоставление для нижней таблицы ---
        let used2 = new Array(body2.length).fill(false);
        let pairs = [];
        function countMatches(rowA, rowB) {
            let matches = 0;
            for (let i = 0; i < allCols; i++) {
                if ((rowA[i] || '') === (rowB[i] || '')) matches++;
            }
            return matches;
        }
        for (let i = 0; i < body1.length; i++) {
            let bestIdx = -1, bestScore = -1;
            for (let j = 0; j < body2.length; j++) {
                if (used2[j]) continue;
                let score = countMatches(body1[i], body2[j]);
                if (score > bestScore) {
                    bestScore = score;
                    bestIdx = j;
                }
            }
            if (bestScore >= Math.ceil(allCols / 2)) {
                pairs.push({row1: body1[i], row2: body2[bestIdx]});
                used2[bestIdx] = true;
            } else {
                pairs.push({row1: body1[i], row2: null});
            }
        }
        for (let j = 0; j < body2.length; j++) {
            if (!used2[j]) {
                pairs.push({row1: null, row2: body2[j]});
            }
        }
        // Сохраняем пары для сортировки
        currentPairs = pairs;
        // --- Нижняя таблица с фильтрацией одинаковых строк ---
        let hideSame = document.getElementById('hideSameRows').checked;
        let html = '';
        if (pairs.length > 0) {
            // Заголовки таблицы
            let headerHtml = '<tr><th>Source</th>';
            for (let c = 0; c < allCols; c++) {
                headerHtml += `<th class="sortable" onclick="sortTable(${c})">${headers[c] !== undefined ? headers[c] : ''}</th>`;
            }
            headerHtml += '</tr>';
            document.querySelector('.diff-table-header thead').innerHTML = headerHtml;
            
            // Строка фильтров
            let filterHtml = '<tr><td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>';
            for (let c = 0; c < allCols; c++) {
                filterHtml += `<td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>`;
            }
            filterHtml += '</tr>';
            document.querySelector('.filter-row').innerHTML = filterHtml;
            
            // Тело таблицы
            let bodyHtml = '';
            pairs.forEach(pair => {
                let row1 = pair.row1;
                let row2 = pair.row2;
                // Пропускаем полностью пустые строки
                let isEmpty = true;
                let hasWarn = false;
                let allSame = true;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    if ((v1 && v1.toString().trim() !== '') || (v2 && v2.toString().trim() !== '')) {
                        isEmpty = false;
                    }
                    if (row1 && row2 && v1 !== v2) {
                        hasWarn = true;
                        allSame = false;
                    }
                    if (row1 && row2 && v1 !== v2) allSame = false;
                }
                if (isEmpty) return;
                if (hideSame && row1 && row2 && allSame) return;
                let source = '';
                if (row1 && row2) source = 'Both files';
                else if (row1) source = fileName1 || 'File 1';
                else source = fileName2 || 'File 2';
                let rowClass = hasWarn ? 'rowwarn' : '';
                bodyHtml += `<tr class="${rowClass}">`;
                bodyHtml += `<td>${source}</td>`;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    let cellClass = '';
                    if (!row1 || !row2) cellClass = 'diff';
                    else if (v1 !== v2) cellClass = 'warn';
                    else cellClass = 'identical';
                    if (!row1 && row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v2}</div></td>`;
                    } else if (row1 && !row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    } else if (v1 !== v2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div><div style='border-top:1px solid #eee;color:#555;font-size:90%'>${v2}</div></td>`;
                    } else {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });
            document.querySelector('.diff-table-body tbody').innerHTML = bodyHtml;
        } else {
            document.querySelector('.diff-table-header thead').innerHTML = '';
            document.querySelector('.filter-row').innerHTML = '';
            document.querySelector('.diff-table-body tbody').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:20px;">No different rows found</td></tr>';
        }
    }

    // Глобальные переменные для сортировки
    let currentSortColumn = -1;
    let currentSortDirection = 'asc';
    let currentPairs = [];
    
    function sortTable(column) {
        if (currentSortColumn === column) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = column;
            currentSortDirection = 'asc';
        }
        
        // Сортируем пары
        currentPairs.sort((a, b) => {
            let aVal = '';
            let bVal = '';
            
            // Используем значение из первой строки, если есть, иначе из второй
            if (a.row1 && a.row1[column] !== undefined) {
                aVal = a.row1[column].toString();
            } else if (a.row2 && a.row2[column] !== undefined) {
                aVal = a.row2[column].toString();
            }
            if (b.row1 && b.row1[column] !== undefined) {
                bVal = b.row1[column].toString();
            } else if (b.row2 && b.row2[column] !== undefined) {
                bVal = b.row2[column].toString();
            }
            
            if (currentSortDirection === 'asc') {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        });
        
        // Обновляем отображение
        renderSortedTable();
    }
    
    function renderSortedTable() {
        let hideSame = document.getElementById('hideSameRows').checked;
        let header1 = data1[0] || [];
        let header2 = data2[0] || [];
        let allCols = Math.max(header1.length, header2.length);
        let headers = (header1.length >= header2.length) ? header1 : header2;
        
        if (currentPairs.length > 0) {
            // Заголовки таблицы
            let headerHtml = '<tr><th>Source</th>';
            for (let c = 0; c < allCols; c++) {
                let sortClass = 'sortable';
                if (c === currentSortColumn) {
                    sortClass += currentSortDirection === 'asc' ? ' sort-asc' : ' sort-desc';
                }
                headerHtml += `<th class="${sortClass}" onclick="sortTable(${c})">${headers[c] !== undefined ? headers[c] : ''}</th>`;
            }
            headerHtml += '</tr>';
            document.querySelector('.diff-table-header thead').innerHTML = headerHtml;
            
            // Строка фильтров
            let filterHtml = '<tr><td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>';
            for (let c = 0; c < allCols; c++) {
                filterHtml += `<td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>`;
            }
            filterHtml += '</tr>';
            document.querySelector('.filter-row').innerHTML = filterHtml;
            
            // Тело таблицы
            let bodyHtml = '';
            currentPairs.forEach(pair => {
                let row1 = pair.row1;
                let row2 = pair.row2;
                let isEmpty = true;
                let hasWarn = false;
                let allSame = true;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    if ((v1 && v1.toString().trim() !== '') || (v2 && v2.toString().trim() !== '')) {
                        isEmpty = false;
                    }
                    if (row1 && row2 && v1 !== v2) {
                        hasWarn = true;
                        allSame = false;
                    }
                    if (row1 && row2 && v1 !== v2) allSame = false;
                }
                if (isEmpty) return;
                if (hideSame && row1 && row2 && allSame) return;
                let source = '';
                if (row1 && row2) source = 'Both files';
                else if (row1) source = fileName1 || 'File 1';
                else source = fileName2 || 'File 2';
                let rowClass = hasWarn ? 'rowwarn' : '';
                bodyHtml += `<tr class="${rowClass}">`;
                bodyHtml += `<td>${source}</td>`;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    let cellClass = '';
                    if (!row1 || !row2) cellClass = 'diff';
                    else if (v1 !== v2) cellClass = 'warn';
                    else cellClass = 'identical';
                    if (!row1 && row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v2}</div></td>`;
                    } else if (row1 && !row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    } else if (v1 !== v2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div><div style='border-top:1px solid #eee;color:#555;font-size:90%'>${v2}</div></td>`;
                    } else {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });
            document.querySelector('.diff-table-body tbody').innerHTML = bodyHtml;
        } else {
            document.querySelector('.diff-table-header thead').innerHTML = '';
            document.querySelector('.filter-row').innerHTML = '';
            document.querySelector('.diff-table-body tbody').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:20px;">No different rows found</td></tr>';
        }
    }

    // Инициализация таблицы с пустыми значениями при загрузке страницы
    window.onload = function() {
        let htmlSummary = `
            <table style="margin-bottom:20px; border: 1px solid #ccc;">
                <tr><th>File</th><th>Row Count</th><th>Rows only in this file</th><th>Identical rows</th><th>% Difference</th></tr>
                <tr><td>-</td><td>-</td><td>-</td><td rowspan="2">-</td><td rowspan="2" class="percent-cell">-</td></tr>
                <tr><td>-</td><td>-</td><td>-</td></tr>
            </table>
        `;
        document.getElementById('summary').innerHTML = htmlSummary;
    };

    // Функция фильтрации таблицы
    function filterTable() {
        let filters = [];
        let filterInputs = document.querySelectorAll('.filter-row input[type="text"]');
        filterInputs.forEach(input => {
            filters.push(input.value.toLowerCase());
        });
        
        let rows = document.querySelectorAll('.diff-table-body tbody tr');
        // Пропускаем заголовки и строку фильтров
        for (let i = 0; i < rows.length; i++) {
            let row = rows[i];
            let cells = row.querySelectorAll('td');
            let show = true;
            
            for (let j = 0; j < filters.length && j < cells.length; j++) {
                if (filters[j] && filters[j].trim() !== '') {
                    let cellText = cells[j].textContent.toLowerCase();
                    if (!cellText.includes(filters[j])) {
                        show = false;
                        break;
                    }
                }
            }
            
            row.style.display = show ? '' : 'none';
        }
    }
    </script>
</body>
</html> 