<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel and CSV File Comparison - MaxPilot</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Header will be loaded here -->
    <header>
    <div class="header-container">
        <a href="index.html" class="logo">
            <img src="img/maxpilot.png" alt="MaxPilot Logo">
        </a>
        <nav>
            <ul class="nav-menu">
                <li><a href="index.html#block-1">Problems</a></li>
                <li><a href="index.html#block-4">Security</a></li>
                <li><a href="compare.html" class="nav-cta">Start Comparison</a></li>
                <li><a href="https://medium.com/@protmaks" target="_blank">My Blog</a></li>
                <li><a href="https://www.linkedin.com/in/protmaks/" class="social-link" title="linkedin" target="_blank">
                    <img src="img/linkedin.png" alt="linkedin">
                </a></li>
            </ul>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </div>
</header>
    
    <div class="main-content" style="padding-top: 80px;"><!-- Account for fixed header -->
        <h1>Excel and CSV File Comparison</h1>
        <div id="summary"></div>
        <div class="comparison-container">
            <div class="table-container">
                <label class="file-label">File 1:</label>
                <input type="file" id="file1" accept=".xlsx,.xls,.csv"><br>
                <div id="table1"></div>
            </div>
            <div class="table-container">
                <label class="file-label">File 2:</label>
                <input type="file" id="file2" accept=".xlsx,.xls,.csv"><br>
                <div id="table2"></div>
            </div>
            <div class="controls-container">
                <button class="compare-btn" onclick="compareTables()">Compare</button>
                <label><input type="checkbox" id="hideSameRows" onchange="compareTables()"> hide same rows</label>
            </div>
        </div>
        <div class="preview-container">
            <div id="preview1"></div>
            <div id="preview2"></div>
        </div>
    </div>
    <div id="result"></div>
    <div id="diffTable">
        <div class="table-header-fixed">
            <table class="diff-table-header">
                <thead></thead>
                <tbody class="filter-row"></tbody>
            </table>
        </div>
        <div class="table-body-scrollable">
            <table class="diff-table-body">
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
    let data1 = [], data2 = [];
    let fileName1 = '', fileName2 = '';

    // Function to convert Excel serial date to proper date format
    function convertExcelDate(value) {
        // Check if value is a number that could be an Excel date serial number
        if (typeof value === 'number' && value > 1 && value < 100000) {
            // Excel epoch starts from January 1, 1900 (but Excel incorrectly treats 1900 as a leap year)
            const excelEpoch = new Date(1899, 11, 30); // December 30, 1899
            const date = new Date(excelEpoch.getTime() + value * 24 * 60 * 60 * 1000);
            
            // More strict validation: only convert if the number is in a reasonable date range
            // and the number is large enough to be a plausible Excel date
            if (value >= 25567 && // January 1, 1970 (Unix epoch start)
                value <= 73050 && // Approximately year 2100
                date.getFullYear() >= 1970 && 
                date.getFullYear() <= 2100) {
                // Format as YYYY-MM-DD
                return date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
            }
        }
        
        // Check if value is already a date string in various formats
        if (typeof value === 'string') {
            // First check if it's already in YYYY-MM-DD format - keep it as is
            let isoDateMatch = value.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (isoDateMatch) {
                const year = parseInt(isoDateMatch[1]);
                const month = parseInt(isoDateMatch[2]);
                const day = parseInt(isoDateMatch[3]);
                if (day <= 31 && month <= 12 && year >= 1900 && year <= 2100) {
                    // Already in correct format, just normalize
                    return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                }
            }
            
            // Try to parse common date formats
            let dateMatch;
            
            // DD/MM/YYYY or DD.MM.YYYY format
            dateMatch = value.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})$/);
            if (dateMatch) {
                const day = parseInt(dateMatch[1]);
                const month = parseInt(dateMatch[2]);
                const year = parseInt(dateMatch[3]);
                if (day <= 31 && month <= 12 && year >= 1900 && year <= 2100) {
                    return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                }
            }
            
            // MM/DD/YYYY format
            dateMatch = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (dateMatch) {
                const month = parseInt(dateMatch[1]);
                const day = parseInt(dateMatch[2]);
                const year = parseInt(dateMatch[3]);
                if (day <= 31 && month <= 12 && year >= 1900 && year <= 2100) {
                    return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                }
            }
            
            // Handle cases where Excel might have parsed "2025-05-01" as a calculation
            // Look for patterns like "2019" or "2020" etc that might be date calculations
            if (value.includes('-') && !isoDateMatch) {
                // Try to parse as potential date calculation result
                let parts = value.split('-');
                if (parts.length === 3) {
                    let year = parseInt(parts[0]);
                    let month = parseInt(parts[1]);
                    let day = parseInt(parts[2]);
                    
                    // Check if this could be a valid date
                    if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    }
                }
            }
        }
        
        // Return original value if it's not a date
        return value;
    }

    // Function to round decimal numbers to 2 decimal places
    function roundDecimalNumbers(value) {
        // If it's a number and has decimal places, round to 2 decimal places
        if (typeof value === 'number' && !Number.isInteger(value)) {
            return Math.round(value * 100) / 100;
        }
        
        // If it's a string that represents a decimal number, convert and round
        if (typeof value === 'string' && !isNaN(value) && !isNaN(parseFloat(value))) {
            const numValue = parseFloat(value);
            if (!Number.isInteger(numValue)) {
                return Math.round(numValue * 100) / 100;
            }
        }
        
        return value;
    }

    // Function to process data and convert dates and round decimals
    function processDataWithDates(data) {
        return data.map(row => {
            if (!Array.isArray(row)) return row;
            return row.map(cell => {
                // First try to convert dates
                let processedCell = convertExcelDate(cell);
                // Then round decimal numbers (only if it wasn't converted to a date)
                if (processedCell === cell) {
                    processedCell = roundDecimalNumbers(cell);
                }
                return processedCell;
            });
        });
    }

    document.getElementById('file1').addEventListener('change', function(e) {
        handleFile(e.target.files[0], 1);
    });
    document.getElementById('file2').addEventListener('change', function(e) {
        handleFile(e.target.files[0], 2);
    });

    function removeEmptyColumns(data) {
        if (!data || data.length === 0) return data;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
        let maxCols = Math.max(...data.map(row => row ? row.length : 0));
        if (maxCols === 0) return data;
        
        // –ù–∞—Ö–æ–¥–∏–º —Å—Ç–æ–ª–±—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ
        let columnsToKeep = [];
        for (let col = 0; col < maxCols; col++) {
            let hasContent = false;
            for (let row = 0; row < data.length; row++) {
                if (data[row] && col < data[row].length) {
                    let cellValue = data[row][col];
                    if (cellValue !== null && cellValue !== undefined && cellValue.toString().trim() !== '') {
                        hasContent = true;
                        break;
                    }
                }
            }
            if (hasContent) {
                columnsToKeep.push(col);
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å –Ω–µ–ø—É—Å—Ç—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏
        return data.map(row => {
            if (!row) return [];
            return columnsToKeep.map(colIndex => 
                colIndex < row.length ? row[colIndex] : ''
            );
        });
    }

    function handleFile(file, num) {
        if (!file) return;
        if (num === 1) {
            fileName1 = file.name;
        } else {
            fileName2 = file.name;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            let data = new Uint8Array(e.target.result);
            let workbook = XLSX.read(data, {type: 'array'});
            let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let json = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ''});
            
            // –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            json = json.filter(row => Array.isArray(row) && row.some(cell => (cell !== null && cell !== undefined && cell.toString().trim() !== '')));
            
            // –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç–æ–ª–±—Ü—ã
            json = removeEmptyColumns(json);
            
            // Convert Excel dates to proper format
            json = processDataWithDates(json);
            
            if (num === 1) {
                data1 = json;
                renderPreview(json, 'preview1');
            } else {
                data2 = json;
                renderPreview(json, 'preview2');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function renderTable(data, elementId, diffRowsSet) {
        let html = '<table>';
        if (data.length > 0) {
            html += '<tr>';
            for (let j = 0; j < data[0].length; j++) {
                html += `<th>${data[0][j]}</th>`;
            }
            html += '</tr>';
        }
        for (let i = 1; i < data.length; i++) { // –Ω–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
            let rowClass = (diffRowsSet && diffRowsSet.has(i)) ? 'diff' : '';
            html += `<tr class="${rowClass}">`;
            for (let j = 0; j < data[i].length; j++) {
                html += `<td>${data[i][j]}</td>`;
            }
            html += '</tr>';
        }
        html += '</table>';
        document.getElementById(elementId).innerHTML = html;
    }

    function renderPreview(data, elementId, title) {
        let html = '';
        if (data.length > 0) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø—Ä–µ–≤—å—é
            let previewTitle = '';
            if (elementId === 'preview1') {
                previewTitle = fileName1 ? `Preview: ${fileName1}` : 'Preview: File 1';
            } else {
                previewTitle = fileName2 ? `Preview: ${fileName2}` : 'Preview: File 2';
            }
            
            html += `<div class="preview-title">${previewTitle}</div>`;
            html += '<div class="preview-wrapper">';
            html += '<table class="preview-table">';
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            if (data[0] && data[0].length > 0) {
                html += '<tr>';
                for (let j = 0; j < data[0].length; j++) {
                    let headerValue = data[0][j];
                    headerValue = (headerValue !== null && headerValue !== undefined) ? headerValue.toString() : '';
                    let displayValue = headerValue.length > 20 ? headerValue.substring(0, 20) + '...' : headerValue;
                    let titleAttr = headerValue.length > 20 ? ` title="${headerValue.replace(/"/g, '&quot;')}"` : '';
                    html += `<th${titleAttr}>${displayValue}</th>`;
                }
                html += '</tr>';
            }
            // –ü–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            for (let i = 1; i < Math.min(4, data.length); i++) {
                html += '<tr>';
                for (let j = 0; j < data[i].length; j++) {
                    let cellValue = data[i][j];
                    cellValue = (cellValue !== null && cellValue !== undefined) ? cellValue.toString() : '';
                    let displayValue = cellValue.length > 25 ? cellValue.substring(0, 25) + '...' : cellValue;
                    let titleAttr = cellValue.length > 25 ? ` title="${cellValue.replace(/"/g, '&quot;')}"` : '';
                    html += `<td${titleAttr}>${displayValue}</td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
        }
        document.getElementById(elementId).innerHTML = html;
    }

    function rowToKey(row) {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Å—Ç—Ä–æ–∫—É-–∫–ª—é—á –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        return JSON.stringify(row);
    }

    function showPlaceholderMessage() {
        document.getElementById('result').innerHTML = '';
        document.getElementById('summary').innerHTML = '';
        document.getElementById('diffTable').innerHTML = `
            <div class="placeholder-message">
                <div class="placeholder-icon">üìä</div>
                <div class="placeholder-text">Choose files on your computer and click Compare</div>
            </div>
        `;
    }

    function restoreTableStructure() {
        document.getElementById('diffTable').innerHTML = `
            <div class="table-header-fixed">
                <table class="diff-table-header">
                    <thead></thead>
                    <tbody class="filter-row"></tbody>
                </table>
            </div>
            <div class="table-body-scrollable">
                <table class="diff-table-body">
                    <tbody></tbody>
                </table>
            </div>
        `;
    }

    function compareTables() {
        if (!data1.length || !data2.length) {
            document.getElementById('result').innerText = 'Please, load both files.';
            document.getElementById('summary').innerHTML = '';
            showPlaceholderMessage();
            return;
        }
        
        // Restore table structure for comparison results
        restoreTableStructure();
        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
        let header1 = data1[0] || [];
        let header2 = data2[0] || [];
        let allCols = Math.max(header1.length, header2.length);
        let headers = (header1.length >= header2.length) ? header1 : header2;
        let body1 = data1.slice(1);
        let body2 = data2.slice(1);
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        function rowKey(row) { return JSON.stringify(row.map(x => (x !== undefined ? x : ''))); }
        let set1 = new Set(body1.map(rowKey));
        let set2 = new Set(body2.map(rowKey));
        let only1 = 0, only2 = 0, both = 0;
        set1.forEach(k => { if (set2.has(k)) both++; else only1++; });
        set2.forEach(k => { if (!set1.has(k)) only2++; });
        // --- –í–µ—Ä—Ö–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞ ---
        let totalRows = Math.max(data1.length, data2.length) - 1;
        let maxRows = Math.max(body1.length, body2.length);
        let percentDiff = maxRows > 0 ? (((only1 + only2) / maxRows) * 100).toFixed(2) : '0.00';
        let percentClass = 'percent-low';
        if (parseFloat(percentDiff) > 30) percentClass = 'percent-high';
        else if (parseFloat(percentDiff) > 10) percentClass = 'percent-medium';
        let htmlSummary = `
            <table style="margin-bottom:20px; border: 1px solid #ccc;">
                <tr><th>File</th><th>Row Count</th><th>Rows only in this file</th><th>Identical rows</th><th>% Difference</th></tr>
                <tr><td>${fileName1 || 'File 1'}</td><td>${body1.length}</td><td>${only1}</td><td rowspan="2">${both}</td><td rowspan="2" class="percent-cell ${percentClass}">${percentDiff}%</td></tr>
                <tr><td>${fileName2 || 'File 2'}</td><td>${body2.length}</td><td>${only2}</td></tr>
            </table>
        `;
        document.getElementById('summary').innerHTML = htmlSummary;
        // --- –ù–µ—Å—Ç—Ä–æ–≥–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∏–∂–Ω–µ–π —Ç–∞–±–ª–∏—Ü—ã ---
        let used2 = new Array(body2.length).fill(false);
        let pairs = [];
        function countMatches(rowA, rowB) {
            let matches = 0;
            for (let i = 0; i < allCols; i++) {
                if ((rowA[i] || '') === (rowB[i] || '')) matches++;
            }
            return matches;
        }
        for (let i = 0; i < body1.length; i++) {
            let bestIdx = -1, bestScore = -1;
            for (let j = 0; j < body2.length; j++) {
                if (used2[j]) continue;
                let score = countMatches(body1[i], body2[j]);
                if (score > bestScore) {
                    bestScore = score;
                    bestIdx = j;
                }
            }
            if (bestScore >= Math.ceil(allCols / 2)) {
                pairs.push({row1: body1[i], row2: body2[bestIdx]});
                used2[bestIdx] = true;
            } else {
                pairs.push({row1: body1[i], row2: null});
            }
        }
        for (let j = 0; j < body2.length; j++) {
            if (!used2[j]) {
                pairs.push({row1: null, row2: body2[j]});
            }
        }
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä—ã –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        currentPairs = pairs;
        // --- –ù–∏–∂–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ ---
        let hideSame = document.getElementById('hideSameRows').checked;
        let html = '';
        if (pairs.length > 0) {
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            let headerHtml = '<tr><th>Source</th>';
            for (let c = 0; c < allCols; c++) {
                headerHtml += `<th class="sortable" onclick="sortTable(${c})">${headers[c] !== undefined ? headers[c] : ''}</th>`;
            }
            headerHtml += '</tr>';
            document.querySelector('.diff-table-header thead').innerHTML = headerHtml;
            
            // –°—Ç—Ä–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            let filterHtml = '<tr><td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>';
            for (let c = 0; c < allCols; c++) {
                filterHtml += `<td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>`;
            }
            filterHtml += '</tr>';
            document.querySelector('.filter-row').innerHTML = filterHtml;
            
            // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
            let bodyHtml = '';
            pairs.forEach(pair => {
                let row1 = pair.row1;
                let row2 = pair.row2;
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                let isEmpty = true;
                let hasWarn = false;
                let allSame = true;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    if ((v1 && v1.toString().trim() !== '') || (v2 && v2.toString().trim() !== '')) {
                        isEmpty = false;
                    }
                    if (row1 && row2 && v1 !== v2) {
                        hasWarn = true;
                        allSame = false;
                    }
                    if (row1 && row2 && v1 !== v2) allSame = false;
                }
                if (isEmpty) return;
                if (hideSame && row1 && row2 && allSame) return;
                let source = '';
                if (row1 && row2) source = 'Both files';
                else if (row1) source = fileName1 || 'File 1';
                else source = fileName2 || 'File 2';
                
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Å–æ–≤ —Å—Ç—Ä–æ–∫
                let rowClass = '';
                let hasDiff = !row1 || !row2;
                if (hasDiff) rowClass = 'row-diff';
                else if (hasWarn) rowClass = 'row-warn';
                else if (allSame) rowClass = 'row-identical';
                else rowClass = 'row-default';
                
                bodyHtml += `<tr class="${rowClass}">`;
                bodyHtml += `<td>${source}</td>`;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    let cellClass = '';
                    if (!row1 || !row2) cellClass = 'diff';
                    else if (v1 !== v2) cellClass = 'warn';
                    else cellClass = 'identical';
                    if (!row1 && row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v2}</div></td>`;
                    } else if (row1 && !row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    } else if (v1 !== v2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div><div style='border-top:1px solid #eee;color:#555;font-size:90%'>${v2}</div></td>`;
                    } else {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });
            document.querySelector('.diff-table-body tbody').innerHTML = bodyHtml;
        } else {
            document.querySelector('.diff-table-header thead').innerHTML = '';
            document.querySelector('.filter-row').innerHTML = '';
            document.querySelector('.diff-table-body tbody').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:20px;">No different rows found</td></tr>';
        }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    let currentSortColumn = -1;
    let currentSortDirection = 'asc';
    let currentPairs = [];
    
    function sortTable(column) {
        if (currentSortColumn === column) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = column;
            currentSortDirection = 'asc';
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä—ã
        currentPairs.sort((a, b) => {
            let aVal = '';
            let bVal = '';
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ –≤—Ç–æ—Ä–æ–π
            if (a.row1 && a.row1[column] !== undefined) {
                aVal = a.row1[column].toString();
            } else if (a.row2 && a.row2[column] !== undefined) {
                aVal = a.row2[column].toString();
            }
            if (b.row1 && b.row1[column] !== undefined) {
                bVal = b.row1[column].toString();
            } else if (b.row2 && b.row2[column] !== undefined) {
                bVal = b.row2[column].toString();
            }
            
            if (currentSortDirection === 'asc') {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        renderSortedTable();
    }
    
    function renderSortedTable() {
        let hideSame = document.getElementById('hideSameRows').checked;
        let header1 = data1[0] || [];
        let header2 = data2[0] || [];
        let allCols = Math.max(header1.length, header2.length);
        let headers = (header1.length >= header2.length) ? header1 : header2;
        
        if (currentPairs.length > 0) {
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            let headerHtml = '<tr><th>Source</th>';
            for (let c = 0; c < allCols; c++) {
                let sortClass = 'sortable';
                if (c === currentSortColumn) {
                    sortClass += currentSortDirection === 'asc' ? ' sort-asc' : ' sort-desc';
                }
                headerHtml += `<th class="${sortClass}" onclick="sortTable(${c})">${headers[c] !== undefined ? headers[c] : ''}</th>`;
            }
            headerHtml += '</tr>';
            document.querySelector('.diff-table-header thead').innerHTML = headerHtml;
            
            // –°—Ç—Ä–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            let filterHtml = '<tr><td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>';
            for (let c = 0; c < allCols; c++) {
                filterHtml += `<td><input type="text" placeholder="Filter..." onkeyup="filterTable()" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:3px;"></td>`;
            }
            filterHtml += '</tr>';
            document.querySelector('.filter-row').innerHTML = filterHtml;
            
            // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
            let bodyHtml = '';
            currentPairs.forEach(pair => {
                let row1 = pair.row1;
                let row2 = pair.row2;
                let isEmpty = true;
                let hasWarn = false;
                let allSame = true;
                let hasDiff = false;
                let hasIdentical = false;
                
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    if ((v1 && v1.toString().trim() !== '') || (v2 && v2.toString().trim() !== '')) {
                        isEmpty = false;
                    }
                    if (row1 && row2) {
                        if (v1 !== v2) {
                            hasWarn = true;
                            allSame = false;
                        } else {
                            hasIdentical = true;
                        }
                    } else {
                        hasDiff = true;
                        allSame = false;
                    }
                }
                
                if (isEmpty) return;
                if (hideSame && row1 && row2 && allSame) return;
                
                let source = '';
                if (row1 && row2) source = 'Both files';
                else if (row1) source = fileName1 || 'File 1';
                else source = fileName2 || 'File 2';
                
                let rowClass = '';
                if (hasDiff) rowClass = 'row-diff';
                else if (hasWarn) rowClass = 'row-warn';
                else if (hasIdentical && allSame) rowClass = 'row-identical';
                else rowClass = 'row-default'; // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                
                bodyHtml += `<tr class="${rowClass}">`;
                bodyHtml += `<td>${source}</td>`;
                for (let c = 0; c < allCols; c++) {
                    let v1 = row1 ? (row1[c] !== undefined ? row1[c] : '') : '';
                    let v2 = row2 ? (row2[c] !== undefined ? row2[c] : '') : '';
                    let cellClass = '';
                    if (!row1 || !row2) cellClass = 'diff';
                    else if (v1 !== v2) cellClass = 'warn';
                    else cellClass = 'identical';
                    if (!row1 && row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v2}</div></td>`;
                    } else if (row1 && !row2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    } else if (v1 !== v2) {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div><div style='border-top:1px solid #eee;color:#555;font-size:90%'>${v2}</div></td>`;
                    } else {
                        bodyHtml += `<td class="${cellClass}"><div>${v1}</div></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });
            document.querySelector('.diff-table-body tbody').innerHTML = bodyHtml;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(adjustTableWidth, 50);
        } else {
            document.querySelector('.diff-table-header thead').innerHTML = '';
            document.querySelector('.filter-row').innerHTML = '';
            document.querySelector('.diff-table-body tbody').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:20px;">No different rows found</td></tr>';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        let htmlSummary = `
            <table style="margin-bottom:20px; border: 1px solid #ccc;">
                <tr><th>File</th><th>Row Count</th><th>Rows only in this file</th><th>Identical rows</th><th>% Difference</th></tr>
                <tr><td>-</td><td>-</td><td>-</td><td rowspan="2">-</td><td rowspan="2" class="percent-cell">-</td></tr>
                <tr><td>-</td><td>-</td><td>-</td></tr>
            </table>
        `;
        document.getElementById('summary').innerHTML = htmlSummary;
    };

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã
    function filterTable() {
        let filters = [];
        let filterInputs = document.querySelectorAll('.filter-row input[type="text"]');
        filterInputs.forEach(input => {
            filters.push(input.value.toLowerCase());
        });
        
        let rows = document.querySelectorAll('.diff-table-body tbody tr');
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Å—Ç—Ä–æ–∫—É —Ñ–∏–ª—å—Ç—Ä–æ–≤
        for (let i = 0; i < rows.length; i++) {
            let row = rows[i];
            let cells = row.querySelectorAll('td');
            let show = true;
            
            for (let j = 0; j < filters.length && j < cells.length; j++) {
                if (filters[j] && filters[j].trim() !== '') {
                    let cellText = cells[j].textContent.toLowerCase();
                    if (!cellText.includes(filters[j])) {
                        show = false;
                        break;
                    }
                }
            }
            
            row.style.display = show ? '' : 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω—ã —Ç–∞–±–ª–∏—Ü—ã
    function adjustTableWidth() {
        const headerTable = document.querySelector('.diff-table-header');
        const bodyTable = document.querySelector('.diff-table-body');
        
        if (headerTable && bodyTable) {
            // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —à–∏—Ä–∏–Ω—É –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
            const headerCells = headerTable.querySelectorAll('th, td');
            let totalWidth = 0;
            
            headerCells.forEach(cell => {
                totalWidth += Math.max(150, cell.scrollWidth + 20); // –º–∏–Ω–∏–º—É–º 150px + –æ—Ç—Å—Ç—É–ø—ã
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Ç–∞–±–ª–∏—Ü
            const widthStyle = totalWidth + 'px';
            headerTable.style.width = widthStyle;
            bodyTable.style.width = widthStyle;
            headerTable.style.minWidth = widthStyle;
            bodyTable.style.minWidth = widthStyle;
        }
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Ç–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã
    function syncTableScroll() {
        const headerContainer = document.querySelector('.table-header-fixed');
        const bodyContainer = document.querySelector('.table-body-scrollable');
        
        if (headerContainer && bodyContainer) {
            bodyContainer.addEventListener('scroll', function() {
                headerContainer.scrollLeft = bodyContainer.scrollLeft;
            });
            
            headerContainer.addEventListener('scroll', function() {
                bodyContainer.scrollLeft = headerContainer.scrollLeft;
            });
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏ placeholder –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', function() {
        syncTableScroll();
        showPlaceholderMessage(); // Show placeholder message on page load
    });
    
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é compareTables –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    const originalCompareTables = compareTables;
    compareTables = function() {
        originalCompareTables();
        setTimeout(() => {
            adjustTableWidth();
            syncTableScroll();
        }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    };
    </script>
    
    <!-- Load the shared header -->
    <script src="script.js"></script>
</body>
</html> 