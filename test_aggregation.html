<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Aggregation Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .aggregation-section {
            margin-bottom: 30px;
        }
        
        .aggregation-section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        #aggregationTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        #aggregationTable th,
        #aggregationTable td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        #aggregationTable th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        #aggregationTable tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-compared {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-not-compared {
            color: #e74c3c;
        }
        
        .buttons {
            margin: 20px 0;
            text-align: center;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .test-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        
        .test-section h3 {
            color: #17a2b8;
            margin-top: 0;
        }
        
        .file-input-group {
            margin: 15px 0;
        }
        
        .file-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .file-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä MaxPilot File Aggregation Dashboard</h1>
        
        <div class="aggregation-section">
            <h2>File Statistics Summary</h2>
            <div class="buttons">
                <button class="btn" onclick="refreshAggregationData()">üîÑ Refresh Data</button>
                <button class="btn" onclick="addSampleData()">üìù Add Sample Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <button class="btn" onclick="runSampleComparison()">‚ö° Run Sample Comparison</button>
            </div>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <table id="aggregationTable">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Row Count</th>
                        <th>Identical Rows</th>
                        <th>Rows Only in File</th>
                        <th>Similar Rows</th>
                        <th>Diff Columns</th>
                        <th>% Similarity</th>
                        <th>Status</th>
                        <th>Loaded At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="aggregationTableBody">
                    <tr>
                        <td colspan="10" class="empty-state">
                            No data loaded yet. Use the buttons above to add sample data or load files.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="test-section">
            <h3>üß™ Test File Loading</h3>
            <p>Upload CSV files to test the aggregation functionality:</p>
            
            <div class="file-input-group">
                <label for="file1">File 1:</label>
                <input type="file" id="file1" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(1, this)">
            </div>
            
            <div class="file-input-group">
                <label for="file2">File 2:</label>
                <input type="file" id="file2" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(2, this)">
            </div>
            
            <button class="btn" onclick="compareLoadedFiles()" id="compareBtn" disabled>üîÑ Compare Files</button>
        </div>
        
        <div class="log" id="logOutput">
            <strong>üìã System Log:</strong><br>
            Ready to test aggregation functionality...
        </div>
    </div>

    <!-- Include required libraries -->
    <script src="/javascript/xlsx.full.min.js"></script>
    <script src="/javascript/duckdb-wasm.js"></script>
    
    <script>
        let loadedFiles = { file1: null, file2: null };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            logMessage('üöÄ Initializing MaxPilot DuckDB...');
            
            try {
                if (window.MaxPilotDuckDB && window.MaxPilotDuckDB.initializeFastComparator) {
                    await window.MaxPilotDuckDB.initializeFastComparator();
                    logMessage('‚úÖ MaxPilot DuckDB initialized successfully');
                } else {
                    logMessage('‚ö†Ô∏è MaxPilot DuckDB not available');
                }
            } catch (error) {
                logMessage('‚ùå Failed to initialize: ' + error.message);
            }
            
            // Listen for aggregation updates
            window.addEventListener('aggregationDataUpdated', (event) => {
                logMessage('üìä Aggregation data updated');
                updateAggregationTable(event.detail.data);
            });
            
            await refreshAggregationData();
        });
        
        async function refreshAggregationData() {
            logMessage('üîÑ Refreshing aggregation data...');
            try {
                const data = await window.getAggregationData();
                updateAggregationTable(data);
                logMessage(`üìä Loaded ${data.length} aggregation records`);
            } catch (error) {
                logMessage('‚ùå Failed to refresh data: ' + error.message);
            }
        }
        
        function updateAggregationTable(data) {
            const tbody = document.getElementById('aggregationTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            No data available. Load some files or add sample data to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(row => `
                <tr>
                    <td><strong>${row.file_name}</strong></td>
                    <td>${row.row_count.toLocaleString()}</td>
                    <td>${row.identical_rows.toLocaleString()}</td>
                    <td>${row.rows_only_in_file.toLocaleString()}</td>
                    <td>${row.similar_rows.toLocaleString()}</td>
                    <td>${row.diff_columns}</td>
                    <td>${row.similarity_percent.toFixed(1)}%</td>
                    <td class="${row.is_compared ? 'status-compared' : 'status-not-compared'}">
                        ${row.is_compared ? '‚úÖ Compared' : '‚è≥ Not Compared'}
                    </td>
                    <td>${new Date(row.loaded_at).toLocaleString()}</td>
                    <td>
                        <button class="btn" onclick="removeFile('${row.file_id}')" style="padding: 5px 10px; font-size: 12px;">
                            üóëÔ∏è Remove
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addSampleData() {
            logMessage('üìù Adding sample data...');
            
            try {
                // Sample data 1
                const sampleData1 = [
                    ['ID', 'Name', 'Age', 'City'],
                    [1, 'John Doe', 25, 'New York'],
                    [2, 'Jane Smith', 30, 'London'],
                    [3, 'Bob Johnson', 35, 'Paris'],
                    [4, 'Alice Brown', 28, 'Tokyo']
                ];
                
                // Sample data 2
                const sampleData2 = [
                    ['ID', 'Name', 'Age', 'City'],
                    [1, 'John Doe', 25, 'New York'],
                    [2, 'Jane Smith', 31, 'London'], // Age changed
                    [3, 'Bob Johnson', 35, 'Paris'],
                    [5, 'Charlie Wilson', 42, 'Berlin'] // Different person
                ];
                
                await window.addFileToAggregation('sample1', 'Sample_Data_1.csv', sampleData1);
                await window.addFileToAggregation('sample2', 'Sample_Data_2.csv', sampleData2);
                
                logMessage('‚úÖ Sample data added successfully');
                await refreshAggregationData();
                
            } catch (error) {
                logMessage('‚ùå Failed to add sample data: ' + error.message);
            }
        }
        
        async function clearAllData() {
            if (confirm('Are you sure you want to clear all aggregation data?')) {
                logMessage('üóëÔ∏è Clearing all data...');
                try {
                    await window.clearAggregationData();
                    logMessage('‚úÖ All data cleared');
                    await refreshAggregationData();
                } catch (error) {
                    logMessage('‚ùå Failed to clear data: ' + error.message);
                }
            }
        }
        
        async function removeFile(fileId) {
            if (confirm(`Remove file ${fileId} from aggregation?`)) {
                logMessage(`üóëÔ∏è Removing file ${fileId}...`);
                try {
                    await window.removeFileFromAggregation(fileId);
                    logMessage(`‚úÖ File ${fileId} removed`);
                    await refreshAggregationData();
                } catch (error) {
                    logMessage('‚ùå Failed to remove file: ' + error.message);
                }
            }
        }
        
        async function runSampleComparison() {
            logMessage('‚ö° Running sample comparison...');
            
            try {
                // Show progress
                showProgress(true);
                updateProgress(10, 'Initializing comparison...');
                
                // Initialize comparator
                if (!window.MaxPilotDuckDB || !window.MaxPilotDuckDB.initialized) {
                    throw new Error('MaxPilot DuckDB not initialized');
                }
                
                updateProgress(30, 'Creating sample tables...');
                
                // Create sample data for comparison
                const data1 = [
                    ['Product', 'Price', 'Quantity'],
                    ['Apple', '1.20', '100'],
                    ['Banana', '0.80', '150'],
                    ['Orange', '1.50', '80']
                ];
                
                const data2 = [
                    ['Product', 'Price', 'Quantity'],
                    ['Apple', '1.25', '100'], // Price changed
                    ['Banana', '0.80', '150'],
                    ['Grape', '2.00', '60']   // New product
                ];
                
                updateProgress(50, 'Loading data into DuckDB...');
                
                // Use the FastTableComparator directly
                const comparator = new window.MaxPilotDuckDB.FastTableComparator();
                await comparator.initialize();
                
                updateProgress(70, 'Running comparison...');
                
                const result = await comparator.compareTablesFast(data1, data2, [], false, null);
                
                updateProgress(90, 'Updating aggregation table...');
                
                // Update the aggregation with comparison results
                if (comparator.mode === 'wasm') {
                    await comparator.updateComparisonResults('table1', 'table2', result);
                }
                
                updateProgress(100, 'Comparison completed!');
                
                logMessage(`‚úÖ Comparison completed: ${result.identical.length} identical, ${result.onlyInTable1.length} only in table1, ${result.onlyInTable2.length} only in table2`);
                
                setTimeout(() => {
                    showProgress(false);
                    refreshAggregationData();
                }, 1000);
                
            } catch (error) {
                logMessage('‚ùå Comparison failed: ' + error.message);
                showProgress(false);
            }
        }
        
        function handleFileUpload(fileNum, input) {
            const file = input.files[0];
            if (!file) return;
            
            logMessage(`üìÇ Loading file ${fileNum}: ${file.name}`);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let data;
                    
                    if (file.name.endsWith('.csv')) {
                        // Parse CSV
                        const text = e.target.result;
                        const lines = text.split('\n');
                        data = lines.filter(line => line.trim()).map(line => {
                            return line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                        });
                    } else {
                        // Parse Excel
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    }
                    
                    loadedFiles[`file${fileNum}`] = { name: file.name, data: data };
                    
                    // Add to aggregation table
                    await window.addFileToAggregation(`file${fileNum}`, file.name, data);
                    
                    logMessage(`‚úÖ File ${fileNum} loaded: ${data.length - 1} rows`);
                    
                    // Enable compare button if both files loaded
                    updateCompareButton();
                    
                } catch (error) {
                    logMessage(`‚ùå Failed to load file ${fileNum}: ${error.message}`);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }
        
        function updateCompareButton() {
            const compareBtn = document.getElementById('compareBtn');
            const hasFiles = loadedFiles.file1 && loadedFiles.file2;
            compareBtn.disabled = !hasFiles;
            compareBtn.textContent = hasFiles ? 'üîÑ Compare Files' : 'üìÅ Load Both Files First';
        }
        
        async function compareLoadedFiles() {
            if (!loadedFiles.file1 || !loadedFiles.file2) {
                logMessage('‚ö†Ô∏è Please load both files first');
                return;
            }
            
            logMessage('‚ö° Comparing loaded files...');
            showProgress(true);
            
            try {
                updateProgress(20, 'Initializing comparison...');
                
                const comparator = new window.MaxPilotDuckDB.FastTableComparator();
                await comparator.initialize();
                
                updateProgress(50, 'Running comparison...');
                
                const result = await comparator.compareTablesFast(
                    loadedFiles.file1.data,
                    loadedFiles.file2.data,
                    [], false, null
                );
                
                updateProgress(80, 'Updating results...');
                
                if (comparator.mode === 'wasm') {
                    await comparator.updateComparisonResults('file1', 'file2', result);
                }
                
                updateProgress(100, 'Comparison completed!');
                
                logMessage(`‚úÖ Comparison completed: ${result.identical.length} identical, ${result.onlyInTable1.length} only in file1, ${result.onlyInTable2.length} only in file2`);
                
                setTimeout(() => {
                    showProgress(false);
                    refreshAggregationData();
                }, 1000);
                
            } catch (error) {
                logMessage('‚ùå Comparison failed: ' + error.message);
                showProgress(false);
            }
        }
        
        function showProgress(show) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0, '');
            }
        }
        
        function updateProgress(percent, message) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
            
            if (message) {
                logMessage(`üìä Progress: ${percent}% - ${message}`);
            }
        }
        
        function logMessage(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `<br>[${timestamp}] ${message}`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
    </script>
</body>
</html>